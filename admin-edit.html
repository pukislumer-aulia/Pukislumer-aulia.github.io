<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Edit Pesanan ‚Äî Pukis Lumer Admin</title>
<link rel="stylesheet" href="assets/css/admin.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<div class="admin-header">
  <div class="admin-header-inner admin-container">
    <div><strong>Edit Pesanan</strong></div>
    <div class="admin-header-right">
      <button id="backBtn" class="btn btn-primary">Kembali</button>
    </div>
  </div>
</div>

<main class="admin-container">
  <form id="editOrderForm">
    <label>Nama:</label>
    <input type="text" id="editNama" required>
    <label>WA:</label>
    <input type="text" id="editWA" required>
    <label>Jenis Pukis:</label>
    <select id="editJenis">
      <option value="Original">Original</option>
      <option value="Pandan">Pandan</option>
    </select>
    <label>Ukuran Box:</label>
    <select id="editUkuran">
      <option value="kecil">Kecil</option>
      <option value="besar">Besar</option>
    </select>
    <label>Mode Topping:</label>
    <select id="editMode">
      <option value="none">Non Topping</option>
      <option value="single">Single (max 5)</option>
      <option value="double">Double (max 10)</option>
    </select>

    <div class="topping-wrap" id="editToppingContainer"></div>

    <div class="price-summary">
      <div><span>Total:</span> <span id="editTotalHarga">Rp 0</span></div>
    </div>

    <label>Status:</label>
    <select id="editStatus">
      <option value="pending">Belum</option>
      <option value="done">Selesai</option>
    </select>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Simpan</button>
      <button type="button" id="printInvoice" class="btn btn-primary">Cetak PDF</button>
      <button type="button" id="sendToCustomer" class="btn btn-wa">Kirim WA ke Pelanggan</button>
    </div>
  </form>
</main>

<script>
(function(){
  'use strict';
  if(!sessionStorage.getItem("adminLogged")){
    window.location.href="admin-login.html";
  }

  const $ = s => document.querySelector(s);
  const orders = JSON.parse(localStorage.getItem("orders") || "[]");
  const editId = sessionStorage.getItem("editOrderId");
  if(!editId) window.location.href="admin.html";

  const order = orders.find(o=>o.id===editId);
  if(!order) window.location.href="admin.html";

  const nama = $("#editNama");
  const wa = $("#editWA");
  const jenis = $("#editJenis");
  const ukuran = $("#editUkuran");
  const mode = $("#editMode");
  const toppingContainer = $("#editToppingContainer");
  const totalHargaEl = $("#editTotalHarga");
  const status = $("#editStatus");

  nama.value = order.nama;
  wa.value = order.wa;
  jenis.value = order.jenis;
  ukuran.value = order.ukuran;
  mode.value = order.mode;
  status.value = order.status;

  let toppingList = order.single || [];
  let taburanList = order.taburan || [];

  const toppingOptions = ["Coklat","Keju","Srikaya","Milo","Kacang","Kismis","Oreo","Meses","Cornflakes","GreenTea"];

  function renderToppings(){
    toppingContainer.innerHTML = "";
    const limit = mode.value==="single"?5: mode.value==="double"?10:0;
    toppingOptions.forEach(t=>{
      const btn = document.createElement("button");
      btn.type="button";
      btn.textContent=t;
      btn.className="topping-btn "+(mode.value==="single"?"single":"taburan");
      if(mode.value!=="none"){
        const selected = mode.value==="single"? toppingList.includes(t) : toppingList.includes(t)||taburanList.includes(t);
        if(selected) btn.classList.add("active");
      }
      btn.addEventListener("click",()=>{
        if(btn.classList.contains("active")){
          btn.classList.remove("active");
          if(mode.value==="single") toppingList = toppingList.filter(x=>x!==t);
          else taburanList = taburanList.filter(x=>x!==t);
        } else {
          if(mode.value==="single" && toppingList.length>=5) return;
          if(mode.value==="double" && (toppingList.length+taburanList.length)>=10) return;
          btn.classList.add("active");
          if(mode.value==="single") toppingList.push(t);
          else taburanList.push(t);
        }
        updateTotal();
      });
      toppingContainer.appendChild(btn);
    });
  }

  function updateTotal(){
    let price = 0;
    const jenisVal = jenis.value;
    const ukuranVal = ukuran.value;
    const modeVal = mode.value;

    const hargaTable = {
      "Original": {
        "kecil":{"none":10000,"single":13000,"double":15000},
        "besar":{"none":18000,"single":25000,"double":28000}
      },
      "Pandan":{
        "kecil":{"none":13000,"single":15000,"double":18000},
        "besar":{"none":25000,"single":28000,"double":32000}
      }
    };

    price = hargaTable[jenisVal][ukuranVal][modeVal==="none"?"none":modeVal];
    totalHargaEl.textContent = "Rp "+price.toLocaleString();
  }

  renderToppings();
  updateTotal();

  mode.addEventListener("change",()=>{toppingList=[]; taburanList=[]; renderToppings(); updateTotal();});
  jenis.addEventListener("change",updateTotal);
  ukuran.addEventListener("change",updateTotal);

  $("#backBtn").addEventListener("click",()=>window.location.href="admin.html");

  $("#editOrderForm").addEventListener("submit", e=>{
    e.preventDefault();
    order.nama = nama.value;
    order.wa = wa.value;
    order.jenis = jenis.value;
    order.ukuran = ukuran.value;
    order.mode = mode.value;
    order.single = toppingList;
    order.taburan = taburanList;
    order.status = status.value;

    localStorage.setItem("orders",JSON.stringify(orders));
    alert("Data pesanan berhasil disimpan!");
    window.location.href="admin.html";
  });

  $("#printInvoice").addEventListener("click",()=>{
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("INVOICE PEMESANAN",14,18);
    doc.setFontSize(12);
    doc.text(`Invoice: ${order.invoice}`,14,32);
    doc.text(`Nama: ${order.nama}`,14,38);
    doc.text(`WA: ${order.wa}`,14,44);
    doc.text(`Tanggal: ${order.tanggal}`,14,50);
    let toppingText="-";
    if(order.mode==="single") toppingText = (order.single||[]).join(", ");
    if(order.mode==="double") toppingText = `Single: ${(order.single||[]).join(", ")} | Taburan: ${(order.taburan||[]).join(", ")}`;
    doc.autoTable({
      startY:60,
      head:[["Jenis","Isi","Mode","Topping","Jumlah","Total"]],
      body:[[order.jenis, order.isi+" pcs", order.mode, toppingText, order.jumlah, "Rp "+order.total.toLocaleString()]]
    });
    doc.save(`${order.invoice}.pdf`);
  });

  $("#sendToCustomer").addEventListener("click",()=>{
    const msg = `Halo *${order.nama}*, pesanan kamu *${order.invoice}*:\n\nTotal: Rp ${order.total.toLocaleString()}\nStatus: ${order.status==="done"?"Selesai":"Belum diproses"}\n\nTerima kasih üôè`;
    const url = `https://wa.me/${order.wa}?text=${encodeURIComponent(msg)}`;
    window.open(url,"_blank");
  });
})();
</script>

</body>
</html>
