<script>
  const hargaDasar = {
    original: {5: 12000, 10: 22000},
    pandan: {5: 13000, 10: 24000}
  };
  const toppingHarga = {
    single: {5: 15000, 10: 27000},
    double: {5: 18000, 10: 32000}
  };

  const jenis = document.getElementById('jenis');
  const ukuran = document.getElementById('ukuran');
  const jumlah = document.getElementById('jumlah');
  const toppingJenis = document.getElementById('toppingJenis');
  const totalHarga = document.getElementById('totalHarga');
  const form = document.getElementById('pukisForm');
  const singleToppingGroup = document.getElementById('singleToppingGroup');
  const doubleToppingGroup = document.getElementById('doubleToppingGroup');

  function updateToppingDisplay() {
    const jenisTopping = toppingJenis.value;
    if (jenisTopping === 'non') {
      singleToppingGroup.style.display = 'none';
      doubleToppingGroup.style.display = 'none';
    } else if (jenisTopping === 'single') {
      singleToppingGroup.style.display = 'block';
      doubleToppingGroup.style.display = 'none';
    } else if (jenisTopping === 'double') {
      singleToppingGroup.style.display = 'block';
      doubleToppingGroup.style.display = 'block';
    }
  }

  function hitungTotal() {
    const jenisVal = jenis.value;
    const ukuranVal = ukuran.value;
    const jumlahVal = parseInt(jumlah.value) || 0;
    const toppingVal = toppingJenis.value;

    if (!jenisVal || !ukuranVal || !jumlahVal) {
      totalHarga.innerText = 'Total: Rp 0';
      return;
    }

    let hargaPerBox = toppingVal === 'non'
      ? hargaDasar[jenisVal][ukuranVal]
      : toppingHarga[toppingVal][ukuranVal];

    const total = hargaPerBox * jumlahVal;
    totalHarga.innerText = `Total: Rp ${total.toLocaleString('id-ID')}`;
  }

  function getSelectedToppings(selector) {
    return Array.from(document.querySelectorAll(selector + ':checked'))
                .map(el => el.value);
  }

  function validateToppingLimit() {
    const toppingVal = toppingJenis.value;
    const boxSize = parseInt(ukuran.value);
    let valid = true;

    const single = getSelectedToppings('.singleTopping');
    const double = getSelectedToppings('.doubleTopping');

    if (toppingVal === 'single') {
      if (single.length > boxSize) {
        alert(`Maksimal ${boxSize} topping untuk ${boxSize} pukis.`);
        valid = false;
      }
    } else if (toppingVal === 'double') {
      if ((single.length + double.length) > boxSize) {
        alert(`Total topping (single + double) tidak boleh lebih dari ${boxSize}.`);
        valid = false;
      }
    }

    return valid;
  }

  // Event listeners
  jenis.addEventListener('change', hitungTotal);
  ukuran.addEventListener('change', () => {
    updateToppingDisplay();
    hitungTotal();
  });
  jumlah.addEventListener('input', hitungTotal);
  toppingJenis.addEventListener('change', () => {
    updateToppingDisplay();
    hitungTotal();
  });

  document.querySelectorAll('.singleTopping, .doubleTopping').forEach(el => {
    el.addEventListener('change', hitungTotal);
  });

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!validateToppingLimit()) return;

    const pesan = `Halo! Saya ingin memesan Pukis:

- Jenis: ${jenis.value}
- Ukuran: ${ukuran.value} pcs
- Jumlah: ${jumlah.value} box
- Topping: ${toppingJenis.value}`;

    const single = getSelectedToppings('.singleTopping').join(', ');
    const double = getSelectedToppings('.doubleTopping').join(', ');
    const toppingDetail =
      toppingJenis.value === 'single'
        ? `\n- Rasa: ${single}`
        : toppingJenis.value === 'double'
        ? `\n- Rasa: ${single}\n- Taburan: ${double}`
        : '';

    const totalText = totalHarga.innerText;
    const finalPesan = `${pesan}${toppingDetail}\n${totalText}`;
    const encoded = encodeURIComponent(finalPesan);
    const wa = `https://wa.me/6281296668670?text=${encoded}`;
    window.open(wa, '_blank');
  });
</script>
